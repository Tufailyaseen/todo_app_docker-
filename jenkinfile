#!/usr/bin/env groovy
pipeline {
   agent any
   environment {
        EMAIL_TO = 'malik.tufail@zigron.com'
        PATH = "$PATH:/usr/share/maven/"
    }
   stages {
        stage('Checkout') {
            steps {
                sh "rm * -r" 
                sh "rm -r -f  gitclone"
                sh "mkdir gitclone"
                
               dir ('gitclone') {
                    checkout([$class: 'GitSCM', branches: [[name: '*/dev']], doGenerateSubmoduleConfigurations: false, extensions: [], submoduleCfg: [], userRemoteConfigs: [[url: 'https://github.com/Tufailyaseen/todo_app_docker-.git']]])
                }
                 sh "ls -lart ./*"
            }
        }
        
        stage('Build'){
            steps
            {
            sh 'mvn -Dplugin=install help:describe'
            // sh 'mvn install:install-file "-Dfile=cobra.jar" "-DgroupId=com.cobra" "-DartifactId=cobra" "-Dversion=0.98.4" "-Dpackaging=jar" "-DgeneratePom=true"'
            
             dir ('gitclone'){
                   sh "docker stop gitclone_frontend-todo_1 gitclone_api-todo_1 gitclone_mongodb_1"
                   sh "docker rm  gitclone_frontend-todo_1 gitclone_api-todo_1 gitclone_mongodb_1"
                  

                   }
                 
               
            
        }
   }
   stage ('Test'){
       steps {
          
                dir('gitclone'){
                 
               sh " docker-compose -f docker-compose.prod.yml up -d --build"
            }
       }
   }
 stage('SonarQube analysis') {
//    def scannerHome = tool 'SonarScanner 4.0';
        steps{
        withSonarQubeEnv('sonarqube 9.3') { 
        // If you have configured more than one global server connection, you can specify its name
//      sh "${scannerHome}/bin/sonar-scanner"
        sh "mvn sonar:sonar"
    }
        }  
}
}


post {
        failure {
            emailext body: 'Check console output at $BUILD_URL to view the results. \n\n ${CHANGES} \n\n -------------------------------------------------- \n${BUILD_LOG, maxLines=100, escapeHtml=false}', 
                    to: "${EMAIL_TO}", 
                    subject: 'Build failed in Jenkins: $PROJECT_NAME - #$BUILD_NUMBER'
        }
        unstable {
            emailext body: 'Check console output at $BUILD_URL to view the results. \n\n ${CHANGES} \n\n -------------------------------------------------- \n${BUILD_LOG, maxLines=100, escapeHtml=false}', 
                    to: "${EMAIL_TO}", 
                    subject: 'Unstable build in Jenkins: $PROJECT_NAME - #$BUILD_NUMBER'
        }
        changed {
            emailext body: 'Check console output at $BUILD_URL to view the results.', 
                    to: "${EMAIL_TO}", 
                    subject: 'Jenkins build is back to normal: $PROJECT_NAME - #$BUILD_NUMBER'
        }
        success {
            emailext body: 'Check console output at $BUILD_URL to view the results.', 
                    to: "${EMAIL_TO}", 
                    subject: 'Successfull build: $PROJECT_NAME - #$BUILD_NUMBER'
            
        }
        aborted{
            emailext body: 'Check console output at $BUILD_URL to view the results.', 
                    to: "${EMAIL_TO}", 
                    subject: 'Build Abort: $PROJECT_NAME - #$BUILD_NUMBER'
            
        }
  
}
}

